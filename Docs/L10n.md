# JmcModLib L10n（本地化）使用与集成指南

本文档介绍 `L10n` 模块的职责、API、文件布局与生命周期，帮助 MOD 在 JmcModLib 中加载与使用多语言文本。

## 1. 角色与职责
- 按 Assembly 管理本地化资源（每个 MOD 独立表）。
- 监听游戏语言变化并自动刷新当前语言数据。
- 提供查询接口 `L10n.Get(key, asm)`，优先当前语言，其次 fallback 语言，最后返回 key。

## 2. 生命周期
- 初始化：`L10n.Init()`（由库内部调用）
  - 读取 `LocalizationManager.CurrentLanguage` 作为初始语言
  - 订阅 `LocalizationManager.OnSetLanguage` 与 `ModRegistry.OnUnRegistered`
- 卸载：`L10n.Dispose()`
  - 取消订阅事件，清理路径索引与表缓存

## 3. 目录与文件命名
- 语言文件目录：位于 MOD 程序集所在目录的相对路径（默认 `Lang`）
  - 示例：`<mod folder>/Lang`
- 语言文件命名：`{SystemLanguage}.csv`
  - 示例：`English.csv`, `ChineseSimplified.csv`, `Japanese.csv`

CSV 文件格式（两列）：
```
key,value
Start,开始
Exit,退出
```

## 4. 注册与使用
### 4.1 注册语言目录
若需要使用本地化模块，需要在 `ModRegistry` 注册时调用 `RegistL10n` 指定语言目录与 fallback 语言（默认为`Lang`和英文）
```cshar
// 在 RegistryBuilder 链式注册中调用
            ModRegistry.Register(true, VersionInfo.modInfo, VersionInfo.Name, VersionInfo.Version)?
                       .RegisterLogger(uIFlags: LogConfigUIFlags.All)
                       .RegisterL10n()
                       .Done();
```
- 若未找到 fallback 语言对应文件，则自动选取目录下第一个 `.csv` 作为备用语言。
- 如果目录不存在或 Assembly 路径不可用，会输出警告并跳过注册。
- csv各个文件名的对应：
    - 简体中文 -> ChineseSimplified.csv
    - 繁体中文 -> ChineseTraditional.csv
    - 英文 -> English.csv
    - 日文 -> Japanese.csv
    - 韩文 -> Korean.csv
    - 俄文 -> Russian.csv
    - 法语 -> French.csv
    - 德语 -> German.csv
    - 西班牙语 -> Spanish.csv
    - 葡萄牙语 -> Portuguese.csv
    
其他语言参照 SystemLanguage 枚举命名规则，可通过调用`GetLanguageFileName(lang)`构造文件名。
    
### 4.2 获取文本
```csharp
string s1 = L10n.Get("Start");        // 默认：调用者 Assembly
string s2 = L10n.Get("Exit", myAsm);   // 指定 Assembly
```
- 查找顺序：当前语言表 → fallback 表 → 返回 key 本身。
- 提示：若未注册，会直接跳过查找并返回 key，不会有额外开销。

## 5. 语言切换与事件
- 游戏切换语言后（`LocalizationManager.OnSetLanguage`）（Public）：
  - `CurrentLanguage` 更新为新语言；
  - 对所有已注册 Assembly 重新加载对应表；
  - 触发 `LanguageChanged(newLang)` 事件（public）。
  - 不要订阅游戏内部的语言切换事件，否则相关文本可能无法刷新

## 6. 交互与协作
- 与 ModRegistry：在 `OnUnRegistered(asm)` 时自动反注册该 Assembly 的本地化数据。
- 与 ConfigManager：你的配置 UI 文本（不包括持久化`json`的数据）会自动使用本地化 key。

## 7. 故障排查
- 未注册：`L10n.Exist(asm)` 返回 false 时，`Get(key)` 会直接返回 key 并输出警告。
- 当前语言的key不存在：调用 `ExistKey(key, asm)`会返回`false`
- 文件不存在：检查 MOD 目录下 `Lang/{SystemLanguage}.csv` 是否存在；或是否由 fallback 自动挑选到一个 `.csv`。
- CSV 格式错误：确保每行至少两列（key,value），且无重复 key；加载失败会输出错误日志。

## 8. 设计细节
- 表结构：
  - `_localizedTables`：当前语言表
  - `_fallbackTables`：备用语言表
  - `_basePaths`：Assembly → 语言目录路径
- 加载：`LoadForAssembly(asm, lang)` → 拼路径 → `LoadForPath(path)` → `LoadCSV(text)`
- `GetLanguageFileName(lang)`：直接返回 `"{lang}.csv"`

## 9. 最佳实践
- 在有需要的时候使用 `RegistryBuilder.RegistL10n(...)` 中进行注册，若没有变更配置的需求，直接选默认参数就行。
- 文本 key 使用统一前缀（如 `menu.start`），避免冲突与歧义。
- 组合使用 fallback 与目录首个 `.csv` 的兜底策略，保证最少的空值返回。
